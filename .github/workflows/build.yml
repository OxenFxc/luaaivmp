name: Build and Release
run-name: Build ${{ inputs.platform || 'all' }} (${{ github.ref_name }})

on:
  push:
    branches: [ "main" ]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build for'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - linux
        - windows
        - android

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PLATFORM="${{ inputs.platform }}"
          else
            PLATFORM="all"
          fi

          # Define configurations as JSON objects
          LINUX='{"target": "linux", "compiler": "g++", "artifact_name": "simple_lua", "asset_name": "simple_lua", "cxx_flags": "-std=c++17 -Wall -Wextra -Isrc"}'
          WINDOWS='{"target": "windows", "compiler": "x86_64-w64-mingw32-g++", "artifact_name": "simple_lua.exe", "asset_name": "simple_lua.exe", "cxx_flags": "-std=c++17 -Wall -Wextra -Isrc -static"}'
          ANDROID='{"target": "android", "compiler": "android-clang", "artifact_name": "simple_lua_android", "asset_name": "simple_lua_android", "cxx_flags": "-std=c++17 -Wall -Wextra -Isrc -static-libstdc++"}'

          MATRIX_INCLUDE=""

          if [ "$PLATFORM" == "all" ] || [ "$PLATFORM" == "linux" ]; then
            MATRIX_INCLUDE="$LINUX"
          fi

          if [ "$PLATFORM" == "all" ] || [ "$PLATFORM" == "windows" ]; then
            if [ -n "$MATRIX_INCLUDE" ]; then MATRIX_INCLUDE="$MATRIX_INCLUDE,"; fi
            MATRIX_INCLUDE="$MATRIX_INCLUDE$WINDOWS"
          fi

          if [ "$PLATFORM" == "all" ] || [ "$PLATFORM" == "android" ]; then
             if [ -n "$MATRIX_INCLUDE" ]; then MATRIX_INCLUDE="$MATRIX_INCLUDE,"; fi
             MATRIX_INCLUDE="$MATRIX_INCLUDE$ANDROID"
          fi

          echo "matrix={\"include\":[$MATRIX_INCLUDE]}" >> $GITHUB_OUTPUT

  build:
    needs: setup
    name: Build ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}

    defaults:
      run:
        working-directory: SimpleLua

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ccache
        if [ "${{ matrix.target }}" == "windows" ]; then
          sudo apt-get install -y mingw-w64
        fi

    - name: Configure Android Compiler
      if: matrix.target == 'android'
      run: |
        echo "ANDROID_CXX=aarch64-linux-android29-clang++" >> $GITHUB_ENV
        # Add NDK toolchain to PATH so the wrapper can be found
        echo "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-${{ matrix.target }}-ccache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.target }}-ccache-

    - name: Build
      run: |
        export PATH="/usr/lib/ccache:$PATH"
        COMPILER="${{ matrix.compiler }}"

        if [ "${{ matrix.target }}" == "android" ]; then
          COMPILER="$ANDROID_CXX"
        fi

        # Verify compiler exists
        if ! command -v $COMPILER &> /dev/null; then
             echo "Compiler $COMPILER not found"
             exit 1
        fi

        make TARGET="${{ matrix.artifact_name }}" CXX="ccache $COMPILER" CXXFLAGS="${{ matrix.cxx_flags }}"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.asset_name }}
        path: SimpleLua/${{ matrix.artifact_name }}

    - name: Upload Release Asset
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: SimpleLua/${{ matrix.artifact_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
